services:
  ollama:
    image: ollama/ollama:latest
    hostname: ollama
    restart: always
    ports:
      - "11434:11434" # Expose Ollama API to the host for local testing/tools
    volumes:
      - ollama-data:/root/.ollama # Persist downloaded models and cache across restarts
    environment:
      - OLLAMA_KEEP_ALIVE=24h # Keep model loaded in memory to reduce cold-start latency 
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3.2:3b}  # Default model if OLLAMA_MODEL is not set in .env

  malware-api:
    build:
      context: ./services/malware-api
      dockerfile: Dockerfile
    image: malware-api:latest
    hostname: malware-api
    restart: always
    ports:
      - "8000:8000"  # Expose Malware API to the host 
    volumes:
      - malware-db-data:/app/data # Persist malware DB/data storage
    environment:
      - TZ=UTC # Set container timezone for consistent logs/timestamps
      - API_KEY=${MALWARE_API_KEY:-change-me-to-a-secure-key} # API key used to authenticate requests
      - OLLAMA_URL=${OLLAMA_URL:-http://ollama:11434} # Internal URL to reach Ollama from containers
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3.2:3b} # Model name passed through to the API
      - OLLAMA_MAX_TOKENS=${OLLAMA_MAX_TOKENS:-200} # Token limit for responses generated by the model
    depends_on:
      - ollama # Ensure Ollama starts before malware-api attempts to call it

  wazuh.manager:
    build:
      context: ./services/wazuh
      dockerfile: Dockerfile.manager
    image: custom-wazuh-manager:4.14.1
    hostname: wazuh.manager
    restart: always
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 655360
        hard: 655360
    ports:
      - "1514:1514" # Wazuh agent connection port
      - "1515:1515" # Wazuh agent enrollment/auth port
      - "514:514/udp" # Syslog ingestion (UDP)
      - "55000:55000" # Wazuh API port
    environment:
      - INDEXER_URL=https://wazuh.indexer:9200
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=${ADMIN_PASSWORD} # Indexer admin password from .env
      - FILEBEAT_SSL_VERIFICATION_MODE=full
      - SSL_CERTIFICATE_AUTHORITIES=/etc/ssl/root-ca.pem # Root CA used to validate Indexer TLS cert
      - SSL_CERTIFICATE=/etc/ssl/filebeat.pem # Client cert used by Filebeat to connect to Indexer
      - SSL_KEY=/etc/ssl/filebeat.key  # Client key used by Filebeat to connect to Indexer
      - API_USERNAME=wazuh-wui
      - API_PASSWORD=MyS3cr37P450r.*-
      - MALWARE_API_KEY=${MALWARE_API_KEY:-change-me-to-a-secure-key} # Shared key to call malware-api securely 
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN} # Token used for alert notifications
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID} # Chat destination for alert notifications
    volumes:
      - wazuh_api_configuration:/var/ossec/api/configuration
      - wazuh_etc:/var/ossec/etc
      - wazuh_logs:/var/ossec/logs
      - wazuh_queue:/var/ossec/queue
      - wazuh_var_multigroups:/var/ossec/var/multigroups
      - wazuh_active_response:/var/ossec/active-response/bin
      - wazuh_agentless:/var/ossec/agentless
      - wazuh_wodles:/var/ossec/wodles
      - filebeat_etc:/etc/filebeat
      - filebeat_var:/var/lib/filebeat
      - ./services/wazuh/config/wazuh_indexer_ssl_certs/root-ca-manager.pem:/etc/ssl/root-ca.pem # CA bundle inside manager container
      - ./services/wazuh/config/wazuh_indexer_ssl_certs/wazuh.manager.pem:/etc/ssl/filebeat.pem # Filebeat client certificate
      - ./services/wazuh/config/wazuh_indexer_ssl_certs/wazuh.manager-key.pem:/etc/ssl/filebeat.key # Filebeat client private key
      - ./services/wazuh/config/wazuh_manager/local_rules.conf:/wazuh-config-mount/etc/rules/local_rules.xml
      - ./services/wazuh/config/wazuh_manager/agent-template.conf:/wazuh-config-mount/etc/shared/agent-template.conf
    depends_on:
      - malware-api

  wazuh.indexer:
    image: wazuh/wazuh-indexer:4.14.1
    hostname: wazuh.indexer
    restart: always
    ports:
      - "9200:9200"
    environment:
      - "OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - wazuh-indexer-data:/var/lib/wazuh-indexer # Persist OpenSearch index data
      - ./services/wazuh/config/wazuh_indexer_ssl_certs/root-ca.pem:/usr/share/wazuh-indexer/config/certs/root-ca.pem # Root CA for TLS
      - ./services/wazuh/config/wazuh_indexer_ssl_certs/wazuh.indexer-key.pem:/usr/share/wazuh-indexer/config/certs/wazuh.indexer.key  # Indexer private key
      - ./services/wazuh/config/wazuh_indexer_ssl_certs/wazuh.indexer.pem:/usr/share/wazuh-indexer/config/certs/wazuh.indexer.pem # Indexer TLS certificate
      - ./services/wazuh/config/wazuh_indexer_ssl_certs/admin.pem:/usr/share/wazuh-indexer/config/certs/admin.pem # Admin cert for security admin operations
      - ./services/wazuh/config/wazuh_indexer_ssl_certs/admin-key.pem:/usr/share/wazuh-indexer/config/certs/admin-key.pem  # Admin key for security admin operations
      - ./services/wazuh/config/wazuh_indexer/wazuh.indexer.yml:/usr/share/wazuh-indexer/config/opensearch.yml
      - ./services/wazuh/config/wazuh_indexer/internal_users.yml:/usr/share/wazuh-indexer/config/opensearch-security/internal_users.yml # User/password hashes live here
      - ./services/wazuh/config/wazuh_indexer/roles.yml:/usr/share/wazuh-indexer/config/custom-security/roles.yml # Custom roles definition
      - ./services/wazuh/config/wazuh_indexer/roles_mapping.yml:/usr/share/wazuh-indexer/config/custom-security/roles_mapping.yml # Custom role mappings

  wazuh.dashboard:
    image: wazuh/wazuh-dashboard:4.14.1
    hostname: wazuh.dashboard
    restart: always
    ports:
      - 443:5601 # Host 443 -> dashboard 5601
    environment:
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=${ADMIN_PASSWORD} # Indexer admin password from .env
      - WAZUH_API_URL=https://wazuh.manager
      - DASHBOARD_USERNAME=kibanaserver
      - DASHBOARD_PASSWORD=${KIBANASERVER_PASSWORD} # Dashboard service account password from .env
      - API_USERNAME=wazuh-wui
      - API_PASSWORD=MyS3cr37P450r.*-
    volumes:
      - ./services/wazuh/config/wazuh_indexer_ssl_certs/wazuh.dashboard.pem:/usr/share/wazuh-dashboard/certs/wazuh-dashboard.pem # Dashboard TLS certificate
      - ./services/wazuh/config/wazuh_indexer_ssl_certs/wazuh.dashboard-key.pem:/usr/share/wazuh-dashboard/certs/wazuh-dashboard-key.pem # Dashboard TLS private key
      - ./services/wazuh/config/wazuh_indexer_ssl_certs/root-ca.pem:/usr/share/wazuh-dashboard/certs/root-ca.pem # Root CA to validate TLS connections
      - ./services/wazuh/config/wazuh_dashboard/opensearch_dashboards.yml:/usr/share/wazuh-dashboard/config/opensearch_dashboards.yml
      - ./services/wazuh/config/wazuh_dashboard/wazuh.yml:/usr/share/wazuh-dashboard/data/wazuh/config/wazuh.yml
      - wazuh-dashboard-config:/usr/share/wazuh-dashboard/data/wazuh/config
      - wazuh-dashboard-custom:/usr/share/wazuh-dashboard/plugins/wazuh/public/assets/custom
    depends_on:
      - wazuh.indexer
    links:
      - wazuh.indexer:wazuh.indexer
      - wazuh.manager:wazuh.manager

volumes:
  ollama-data:
  malware-db-data:
  # Default wazuh volumes
  wazuh_api_configuration:
  wazuh_etc:
  wazuh_logs:
  wazuh_queue:
  wazuh_var_multigroups:
  wazuh_active_response:
  wazuh_agentless:
  wazuh_wodles:
  filebeat_etc:
  filebeat_var:
  wazuh-indexer-data:
  wazuh-dashboard-config:
  wazuh-dashboard-custom:

# Malware Database API

This is a simple API that checks if file hashes are known malware. It uses the MalwareBazaar database from abuse.ch.

## What Does It Do?

The API lets you check if a file is malware by providing its hash value (MD5, SHA1, or SHA256). The system automatically downloads and updates the malware database every day.

## Features

- Check file hashes against a database of over 3 million malware samples
- Supports MD5, SHA1, and SHA256 hash types
- Automatic daily database updates at 03:00 UTC
- Database stored in a persistent volume
- API key authentication for security
- Health check endpoint for monitoring
- Optional LLM enrichment via an Ollama service (for human-friendly malware summaries)

## Quick Start

### Using Docker Compose

The easiest way to run the API is with Docker Compose:

```bash
docker compose up -d malware-api
```

The API will be available at `http://localhost:8000`

If you also want LLM explanations for malware hits, start the Ollama service defined in `docker-compose.yml`:

```bash
docker compose up -d ollama
```

The Ollama service will be ready to use immediately. The LLM model will download automatically on the first malware API request.

### First Run

When you start the container for the first time, it will:
1. Download the full malware database (this takes a few minutes)
2. Load the database into memory
3. Start the API server
4. Schedule daily updates

**Important**: The database CSV file is around 500 MB to 1 GB in size. Make sure you have at least 2 GB of free disk space available for the database and temporary files.

## Configuration

### Environment Variables

You can configure the API using these environment variables in your docker-compose.yml:

- `API_KEY`: Your secret API key (default: "change-me-to-a-secure-key")
- `TZ`: Timezone for logs (default: "UTC")
- `OLLAMA_URL`: Ollama endpoint to call for enrichment (default: `http://ollama:11434`)
- `OLLAMA_MODEL`: Model name pulled by Ollama (default: `llama3.2:3b`)
- `OLLAMA_MAX_TOKENS`: Maximum tokens returned by the model (default: `200`)

### Changing the API Key

Edit the docker-compose.yml file and change the API_KEY value:

```yaml
environment:
  - API_KEY=your-super-secret-key-here
```

Then restart the container:

```bash
docker compose up -d malware-api
```

## Using the API

### Authentication

All requests need an API key in the header:

```
X-API-Key: your-secret-api-key-here
```

### Check a Hash (GET)

You can check a hash by adding it to the URL:

```bash
curl -H "X-API-Key: your-key" http://localhost:8000/check/3f2ff8fe4206e424aadde6f7b2b47fcd
```

### Check a Hash (POST)

You can also send a POST request with JSON:

```bash
curl -X POST http://localhost:8000/check \
  -H "X-API-Key: your-key" \
  -H "Content-Type: application/json" \
  -d '{"hash": "3f2ff8fe4206e424aadde6f7b2b47fcd"}'
```

### Response Format

If the hash is found in the malware database:

```json
{
  "is_malware": true,
  "hash": "3f2ff8fe4206e424aadde6f7b2b47fcd",
  "hash_type": "md5",
  "details": {
    "first_seen": "2025-12-15 10:23:45",
    "sha256": "abc123...",
    "md5": "3f2ff8fe4206e424aadde6f7b2b47fcd",
    "file_name": "malware.exe",
    "file_type": "exe",
    "mime_type": "application/x-msdownload",
    "signature": "Trojan.Generic",
    "reporter": "Antivirus Corp"
  },
  "title": "Trojan detected in system file",
  "text": "This file is malware that steals data. Remove it immediately and scan your system with antivirus software."
}
```

If the hash is not found:

```json
{
  "is_malware": false,
  "hash": "3f2ff8fe4206e424aadde6f7b2b47fcd",
  "hash_type": "md5",
  "details": null,
  "title": null,
  "text": null
}
```

**LLM Enrichment Fields** (when Ollama is enabled and model loads):
- `title` (string, max 80 characters): A concise threat summary
- `text` (string, max 200 characters): A human-friendly explanation with remediation advice

### Other Endpoints

#### Get API Information

```bash
curl http://localhost:8000/
```

Returns basic information about the API and available endpoints.

#### Get Database Information

```bash
curl -H "X-API-Key: your-key" http://localhost:8000/info
```

Returns details about the database including:
- Total number of malware entries
- Last update time
- Available columns

#### Health Check

```bash
curl http://localhost:8000/health
```

Returns the health status of the API. Used by Docker for health checks.

## Database Updates

### Automatic Updates

The database updates automatically:
- Every day at 03:00 UTC (scheduled update)
- On startup if the database is older than 24 hours
- On first run if no database exists

### Manual Update

To force a database update, you can restart the container and delete the old database:

```bash
docker compose down malware-api
docker volume rm vtcs-project-25-26_malware-db-data
docker compose up -d malware-api
```

The container will download a fresh database on startup.

## Database Location

The malware database is stored in a Docker volume called `malware-db-data`. This means the database stays saved even when you restart or update the container.

Inside the container, the database is at: `/app/data/malware_database.csv`

**Storage Requirements**: The database file is around 500 MB to 1 GB. Make sure your Docker volume has at least 2 GB of free space to handle the database file and updates.

## How Hash Detection Works

1. You send a hash to the API
2. The API detects the hash type based on its length:
   - 32 characters = MD5
   - 40 characters = SHA1
   - 64 characters = SHA256
3. The API searches the database for matching hashes
4. If found, it returns the malware details
5. If not found, it returns a "not malware" response

## Troubleshooting

### Container won't start

Check the logs:
```bash
docker logs vtcs-project-25-26-malware-api-1
```

### Database not downloading

Make sure the container has internet access to download from abuse.ch. The download URL is:
```
https://bazaar.abuse.ch/export/csv/full/
```

### API returns errors

Check that:
- You are using the correct API key in the header
- The hash format is valid (32, 40, or 64 hex characters)
- The database has loaded successfully

### Memory issues

The full database with 3+ million entries needs about 2-3 GB of RAM. With the LLM model (`llama3.2:3b`), you need at least 5 GB of RAM total. Make sure your Docker has enough memory allocated.

## Technical Details

- **Framework**: FastAPI (Python)
- **Database**: Pandas DataFrame in memory
- **Scheduler**: APScheduler for automatic updates
- **Source**: MalwareBazaar by abuse.ch
- **Update frequency**: Daily at 03:00 UTC
- **Health checks**: Every 30 seconds

## Data Source

This API uses the MalwareBazaar database provided by abuse.ch. 

- Website: https://bazaar.abuse.ch/
- Terms of Use: https://bazaar.abuse.ch/faq/#tos

Please respect their terms of service when using this API.

## Support

If you have issues or questions:
1. Check the container logs for error messages
2. Verify your configuration in docker-compose.yml
3. Make sure the database volume has enough disk space
4. Check that the API key is set correctly

## Data Source

Database provided by [MalwareBazaar](https://bazaar.abuse.ch/) (abuse.ch)
- **Terms of Use**: https://bazaar.abuse.ch/faq/#tos
- **Contact**: bazaar [at] abuse.ch

## License

This API service is provided as-is. The malware database is subject to MalwareBazaar's terms of use.
